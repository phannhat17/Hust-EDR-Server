{% extends "layout.html" %}

{% block title %}Dashboard - EDR System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card shadow mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Welcome to the EDR System
                </h5>
            </div>
            <div class="card-body">
                <p>This system integrates with ElastAlert to provide monitoring and notification capabilities for your security events.</p>
                <p>Use the navigation to access:</p>
                <ul>
                    <li><strong>Alerts</strong> - View and manage alerts generated by ElastAlert</li>
                    <li><strong>Rules</strong> - Create and manage ElastAlert rules</li>
                </ul>
                <hr>
                <div class="d-flex">
                    <a href="{{ url_for('alerts_page') }}" class="btn btn-primary me-2">
                        <i class="fas fa-bell me-1"></i> View Alerts
                    </a>
                    <a href="{{ url_for('rules_page') }}" class="btn btn-success">
                        <i class="fas fa-list-check me-1"></i> Manage Rules
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row" id="dashboard-stats">
    <div class="col-md-4">
        <div class="card shadow mb-4 bg-primary text-white">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-bell me-2"></i>
                    Alert Status
                </h5>
                <div class="display-4 fw-bold" id="alert-count">-</div>
                <p class="mb-0">Total alerts</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card shadow mb-4 bg-warning text-white">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    New Alerts
                </h5>
                <div class="display-4 fw-bold" id="new-alert-count">-</div>
                <p class="mb-0">Unresolved alerts</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card shadow mb-4 bg-success text-white">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-list-check me-2"></i>
                    Active Rules
                </h5>
                <div class="display-4 fw-bold" id="rule-count">-</div>
                <p class="mb-0">Configured rules</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card shadow mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-bell me-2"></i>
                    Recent Alerts
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Rule Name</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recent-alerts-table">
                            <tr>
                                <td colspan="4" class="text-center">Loading alerts...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="text-end">
                    <a href="{{ url_for('alerts_page') }}" class="btn btn-primary btn-sm">
                        View All Alerts
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        loadDashboardData();
    });

    async function loadDashboardData() {
        try {
            // Fetch alerts
            const alertsResponse = await axios.get('/api/alerts?limit=5');
            const alerts = alertsResponse.data;
            
            // Fetch rules
            const rulesResponse = await axios.get('/api/rules');
            const rules = rulesResponse.data;
            
            // Update stats
            document.getElementById('alert-count').textContent = alerts.length;
            document.getElementById('rule-count').textContent = rules.length;
            
            // Count new alerts
            const newAlerts = alerts.filter(alert => alert.status === 'new');
            document.getElementById('new-alert-count').textContent = newAlerts.length;
            
            // Update recent alerts table
            updateRecentAlertsTable(alerts.slice(0, 5));
        } catch (error) {
            console.error('Error loading dashboard data:', error);
        }
    }

    function updateRecentAlertsTable(alerts) {
        const tableBody = document.getElementById('recent-alerts-table');
        
        if (alerts.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center">No alerts found</td>
                </tr>
            `;
            return;
        }
        
        let html = '';
        alerts.forEach(alert => {
            const timestamp = new Date(alert.timestamp).toLocaleString();
            const statusClass = getStatusClass(alert.status);
            
            html += `
                <tr>
                    <td>${timestamp}</td>
                    <td>${alert.rule_name}</td>
                    <td>
                        <span class="badge ${statusClass}">${formatStatus(alert.status)}</span>
                    </td>
                    <td>
                        <a href="/alerts?id=${alert.id}" class="btn btn-sm btn-primary">
                            <i class="fas fa-eye"></i> View
                        </a>
                    </td>
                </tr>
            `;
        });
        
        tableBody.innerHTML = html;
    }

    function getStatusClass(status) {
        switch (status) {
            case 'new': return 'bg-warning';
            case 'in_review': return 'bg-info';
            case 'in_progress': return 'bg-primary';
            case 'resolved': return 'bg-success';
            case 'false_positive': return 'bg-secondary';
            default: return 'bg-secondary';
        }
    }

    function formatStatus(status) {
        if (!status) return 'Unknown';
        return status.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
    }
</script>
{% endblock %} 