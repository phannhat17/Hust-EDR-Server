{% extends "layout.html" %}

{% block title %}Dashboard - EDR System{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow">
            <div class="card-body p-4">
                <div class="d-flex align-items-center mb-3">
                    <i class="fas fa-shield-alt text-primary fa-2x me-3"></i>
                    <h4 class="card-title mb-0">Welcome to the EDR System</h4>
                </div>
                <p class="lead">This system integrates with ElastAlert to provide monitoring and notification capabilities for your security events.</p>
                <hr class="my-3">
                <div class="row">
                    <div class="col-md-6">
                        <h5 class="mb-3"><i class="fas fa-compass me-2"></i>Quick Navigation</h5>
                        <div class="d-flex flex-wrap gap-2">
                            <a href="{{ url_for('alerts_page') }}" class="btn btn-primary">
                                <i class="fas fa-bell me-2"></i> View Alerts
                            </a>
                            <a href="{{ url_for('rules_page') }}" class="btn btn-success">
                                <i class="fas fa-list-check me-2"></i> Manage Rules
                            </a>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5 class="mb-3"><i class="fas fa-info-circle me-2"></i>Key Features</h5>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item bg-transparent border-0 py-1 ps-0">
                                <i class="fas fa-check-circle text-success me-2"></i> View and manage alerts generated by ElastAlert
                            </li>
                            <li class="list-group-item bg-transparent border-0 py-1 ps-0">
                                <i class="fas fa-check-circle text-success me-2"></i> Create and manage ElastAlert rules
                            </li>
                            <li class="list-group-item bg-transparent border-0 py-1 ps-0">
                                <i class="fas fa-check-circle text-success me-2"></i> Monitor security events in real-time
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="card bg-primary text-white h-100">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h5 class="card-title mb-3">Total Alerts</h5>
                        <div class="display-4 fw-bold mb-2" id="alert-count">-</div>
                        <p class="mb-0">All-time alerts</p>
                    </div>
                    <div class="icon-bg">
                        <i class="fas fa-bell fa-3x opacity-25"></i>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-transparent border-0 text-center pb-3">
                <a href="{{ url_for('alerts_page') }}" class="text-white text-decoration-none small">
                    <span>View All Alerts</span>
                    <i class="fas fa-arrow-right ms-1"></i>
                </a>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-warning text-white h-100">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h5 class="card-title mb-3">New Alerts</h5>
                        <div class="display-4 fw-bold mb-2" id="new-alert-count">-</div>
                        <p class="mb-0">Unresolved alerts</p>
                    </div>
                    <div class="icon-bg">
                        <i class="fas fa-exclamation-triangle fa-3x opacity-25"></i>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-transparent border-0 text-center pb-3">
                <a href="{{ url_for('alerts_page') }}?status=new" class="text-white text-decoration-none small">
                    <span>View New Alerts</span>
                    <i class="fas fa-arrow-right ms-1"></i>
                </a>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-success text-white h-100">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h5 class="card-title mb-3">Active Rules</h5>
                        <div class="display-4 fw-bold mb-2" id="rule-count">-</div>
                        <p class="mb-0">Configured rules</p>
                    </div>
                    <div class="icon-bg">
                        <i class="fas fa-list-check fa-3x opacity-25"></i>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-transparent border-0 text-center pb-3">
                <a href="{{ url_for('rules_page') }}" class="text-white text-decoration-none small">
                    <span>Manage Rules</span>
                    <i class="fas fa-arrow-right ms-1"></i>
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card shadow">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-bell me-2 text-primary"></i>
                    <span class="fw-bold">Recent Alerts</span>
                </div>
                <a href="{{ url_for('alerts_page') }}" class="btn btn-sm btn-primary">
                    View All
                </a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-4">Time</th>
                                <th>Rule Name</th>
                                <th>Status</th>
                                <th class="text-end pe-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recent-alerts-table">
                            <tr>
                                <td colspan="4" class="text-center py-4">
                                    <div class="d-flex justify-content-center align-items-center">
                                        <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <span>Loading alerts...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        loadDashboardData();
    });

    async function loadDashboardData() {
        try {
            // Show loading indicators
            showLoadingState();
            
            // Fetch alerts
            const alertsResponse = await axios.get('/api/alerts?limit=5');
            const alerts = alertsResponse.data;
            
            // Fetch rules
            const rulesResponse = await axios.get('/api/rules');
            const rules = rulesResponse.data;
            
            // Update stats with animation
            animateCounter('alert-count', 0, alerts.length, 1000);
            animateCounter('rule-count', 0, rules.length, 1000);
            
            // Count new alerts
            const newAlerts = alerts.filter(alert => alert.status === 'new');
            animateCounter('new-alert-count', 0, newAlerts.length, 1000);
            
            // Update recent alerts table
            updateRecentAlertsTable(alerts.slice(0, 5));
        } catch (error) {
            console.error('Error loading dashboard data:', error);
            showErrorState();
        }
    }

    function showLoadingState() {
        // Already handled in HTML
    }

    function showErrorState() {
        document.getElementById('recent-alerts-table').innerHTML = `
            <tr>
                <td colspan="4" class="text-center py-4 text-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Failed to load data. Please try refreshing the page.
                </td>
            </tr>
        `;
    }

    function animateCounter(elementId, start, end, duration) {
        const element = document.getElementById(elementId);
        const range = end - start;
        const increment = end > start ? 1 : -1;
        const stepTime = Math.abs(Math.floor(duration / range));
        let current = start;
        
        const timer = setInterval(() => {
            current += increment;
            element.textContent = current;
            if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
                element.textContent = end;
                clearInterval(timer);
            }
        }, stepTime);
    }

    function updateRecentAlertsTable(alerts) {
        const tableBody = document.getElementById('recent-alerts-table');
        
        if (alerts.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center py-4">
                        <i class="fas fa-info-circle me-2 text-info"></i>
                        No alerts found
                    </td>
                </tr>
            `;
            return;
        }
        
        let html = '';
        alerts.forEach(alert => {
            const timestamp = new Date(alert.timestamp).toLocaleString();
            const statusClass = getStatusClass(alert.status);
            
            html += `
                <tr class="fade-in">
                    <td class="ps-4">${timestamp}</td>
                    <td>${alert.rule_name}</td>
                    <td>
                        <span class="badge ${statusClass}">${formatStatus(alert.status)}</span>
                    </td>
                    <td class="text-end pe-4">
                        <a href="/alerts?id=${alert.id}" class="btn btn-sm btn-primary">
                            <i class="fas fa-eye"></i> View
                        </a>
                    </td>
                </tr>
            `;
        });
        
        tableBody.innerHTML = html;
    }

    function getStatusClass(status) {
        switch (status) {
            case 'new': return 'bg-warning';
            case 'in_review': return 'bg-info';
            case 'in_progress': return 'bg-primary';
            case 'resolved': return 'bg-success';
            case 'false_positive': return 'bg-secondary';
            default: return 'bg-secondary';
        }
    }

    function formatStatus(status) {
        if (!status) return 'Unknown';
        return status.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
    }
</script>
{% endblock %} 